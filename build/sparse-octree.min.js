/**
 * sparse-octree v6.0.2 build Sat Jan 18 2020
 * https://github.com/vanruesc/sparse-octree
 * Copyright 2020 Raoul van RÃ¼schen
 * @license Zlib
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("math-ds"),require("iterator-result")):"function"==typeof define&&define.amd?define(["exports","math-ds","iterator-result"],n):n((t=t||self).SPARSEOCTREE={},t.MATHDS,t.ITERATORRESULT)}(this,(function(t,n,e){"use strict";function i(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function r(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,n,e){return n&&r(t.prototype,n),e&&r(t,e),t}function l(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&u(t,n)}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,n){return(u=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}function s(t,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):n}function c(t,n,e){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,n,e){var i=function(t,n){for(;!Object.prototype.hasOwnProperty.call(t,n)&&null!==(t=a(t)););return t}(t,n);if(i){var r=Object.getOwnPropertyDescriptor(i,n);return r.get?r.get.call(e):r.value}})(t,n,e||t)}function h(t){return function(t){if(Array.isArray(t)){for(var n=0,e=new Array(t.length);n<t.length;n++)e[n]=t[n];return e}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}e=e&&e.hasOwnProperty("default")?e.default:e;var f=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],y=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],d=new n.Vector3,p=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.Vector3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,t),this.min=e,this.size=r,this.children=null}return o(t,[{key:"getCenter",value:function(t){return t.copy(this.min).addScalar(.5*this.size)}},{key:"getDimensions",value:function(t){return t.set(this.size,this.size,this.size)}},{key:"split",value:function(){var t,e,i=this.min,r=this.getCenter(d),o=.5*this.size,l=this.children=[null,null,null,null,null,null,null,null];for(t=0;t<8;++t)e=y[t],l[t]=new this.constructor(new n.Vector3(0===e[0]?i.x:r.x,0===e[1]?i.y:r.y,0===e[2]?i.z:r.z),o)}},{key:"max",get:function(){return this.min.clone().addScalar(this.size)}}]),t}(),v=new n.Vector3,g=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.Vector3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new n.Vector3;i(this,t),this.min=e,this.max=r,this.children=null}return o(t,[{key:"getCenter",value:function(t){return t.addVectors(this.min,this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(t){return t.subVectors(this.max,this.min)}},{key:"split",value:function(){var t,e,i=this.min,r=this.max,o=this.getCenter(v),l=this.children=[null,null,null,null,null,null,null,null];for(t=0;t<8;++t)e=y[t],l[t]=new this.constructor(new n.Vector3(0===e[0]?i.x:o.x,0===e[1]?i.y:o.y,0===e[2]?i.z:o.z),new n.Vector3(0===e[0]?o.x:r.x,0===e[1]?o.y:r.y,0===e[2]?o.z:r.z))}}]),t}(),m=function t(n,e,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;i(this,t),this.distance=n,this.distanceToRay=e,this.point=r,this.object=o};function w(t,e,i){var r,o,l,a,u,s,c,h,f,y,d,p=e.params.Points.threshold,v=p*p;for(u=0,c=t.length;u<c;++u)if(null!==(y=(f=t[u]).points))for(s=0,h=y.length;s<h;++s)d=y[s],(a=e.ray.distanceSqToPoint(d))<v&&(r=e.ray.closestPointToPoint(d,new n.Vector3),(o=e.ray.origin.distanceTo(r))>=e.near&&o<=e.far&&(l=Math.sqrt(a),i.push(new m(o,l,r,f.data[s]))))}var x=function t(){i(this,t),this.value=0};function b(t,n,e,i,r,o){var l=0;return t>n&&t>e?(r<t&&(l|=2),o<t&&(l|=1)):n>e?(i<n&&(l|=4),o<n&&(l|=1)):(i<e&&(l|=4),r<e&&(l|=2)),l}var k=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])];function A(t,n,e,i){var r,o=0;return n<e?(r=n,o=0):(r=e,o=1),i<r&&(o=2),k[t][o]}var O=new n.Vector3,z=new n.Box3,U=new n.Box3,P=new n.Ray;function S(t,n,e){var i,r,o,l,a,u,s,c,h,f=z.min.set(0,0,0),y=z.max.subVectors(t.max,t.min),d=t.getDimensions(U.min),p=U.max.copy(d).multiplyScalar(.5),v=P.origin.copy(n.origin),g=P.direction.copy(n.direction);return v.sub(t.getCenter(O)).add(p),e.value=0,g.x<0&&(v.x=d.x-v.x,g.x=-g.x,e.value|=4),g.y<0&&(v.y=d.y-v.y,g.y=-g.y,e.value|=2),g.z<0&&(v.z=d.z-v.z,g.z=-g.z,e.value|=1),i=1/g.x,r=1/g.y,o=1/g.z,l=(f.x-v.x)*i,a=(y.x-v.x)*i,u=(f.y-v.y)*r,s=(y.y-v.y)*r,c=(f.z-v.z)*o,h=(y.z-v.z)*o,Math.max(Math.max(l,u),c)<Math.min(Math.min(a,s),h)?[l,u,c,a,s,h]:null}var T=new x;function C(t,n,e,i,r,o,l,a){if(r>=0&&o>=0&&l>=0){var u=t.children;if(null===u)a.push(t);else{var s=.5*(n+r),c=.5*(e+o),h=.5*(i+l),f=T.value,y=b(n,e,i,s,c,h);do{switch(y){case 0:C(u[f],n,e,i,s,c,h,a),y=A(y,s,c,h);break;case 1:C(u[1^f],n,e,h,s,c,l,a),y=A(y,s,c,l);break;case 2:C(u[2^f],n,c,i,s,o,h,a),y=A(y,s,o,h);break;case 3:C(u[3^f],n,c,h,s,o,l,a),y=A(y,s,o,l);break;case 4:C(u[4^f],s,e,i,r,c,h,a),y=A(y,r,c,h);break;case 5:C(u[5^f],s,e,h,r,c,l,a),y=A(y,r,c,l);break;case 6:C(u[6^f],s,c,i,r,o,h,a),y=A(y,r,o,h);break;case 7:C(u[7^f],s,c,h,r,o,l,a),y=8}}while(y<8)}}}var j=function(){function t(){i(this,t)}return o(t,null,[{key:"intersectOctree",value:function(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=S(t,n,T);null!==i&&C.apply(void 0,[t.root].concat(h(i),[e]))}}]),t}(),q=new n.Box3,V=function(){function t(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i(this,t),this.octree=n,this.region=r,this.cull=null!==r,this.result=new e,this.trace=null,this.indices=null,this.reset()}return o(t,[{key:"reset",value:function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(q.min=t.min,q.max=t.max,this.cull&&!this.region.intersectsBox(q)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this}},{key:"next",value:function(){for(var t,n,e,i=this.cull,r=this.region,o=this.indices,l=this.trace,a=null,u=l.length-1;null===a&&u>=0;)if(t=o[u]++,n=l[u].children,t<8)if(null!==n){if(e=n[t],i&&(q.min=e.min,q.max=e.max,!r.intersectsBox(q)))continue;l.push(e),o.push(0),++u}else a=l.pop(),o.pop();else l.pop(),o.pop(),--u;return this.result.value=a,this.result.done=null===a,this.result}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),R=new n.Box3;var M=function(){function t(n){i(this,t),this.root=n}return o(t,[{key:"getCenter",value:function(t){return this.root.getCenter(t)}},{key:"getDimensions",value:function(t){return this.root.getDimensions(t)}},{key:"cull",value:function(t){var n=[];return function t(n,e,i){var r,o,l=n.children;if(R.min=n.min,R.max=n.max,e.intersectsBox(R))if(null!==l)for(r=0,o=l.length;r<o;++r)t(l[r],e,i);else i.push(n)}(this.root,t,n),n}},{key:"getDepth",value:function(){return function t(n){var e,i,r,o=n.children,l=0;if(null!==o)for(e=0,i=o.length;e<i;++e)(r=1+t(o[e]))>l&&(l=r);return l}(this.root)}},{key:"findNodesByLevel",value:function(t){var n=[];return function t(n,e,i,r){var o,l,a=n.children;if(i===e)r.push(n);else if(null!==a)for(++i,o=0,l=a.length;o<l;++o)t(a[o],e,i,r)}(this.root,t,0,n),n}},{key:"raycast",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return j.intersectOctree(this,t.ray,n),n}},{key:"leaves",value:function(t){return new V(this,t)}},{key:Symbol.iterator,value:function(){return new V(this)}},{key:"min",get:function(){return this.root.min}},{key:"max",get:function(){return this.root.max}},{key:"children",get:function(){return this.root.children}}]),t}(),D=new n.Vector3,E=function(t){function n(t,e){var r;return i(this,n),(r=s(this,a(n).call(this,t,e))).points=null,r.data=null,r}return l(n,t),o(n,[{key:"distanceToSquared",value:function(t){return D.copy(t).clamp(this.min,this.max).sub(t).lengthSquared()}},{key:"distanceToCenterSquared",value:function(t){var n=this.getCenter(D),e=t.x-n.x,i=t.y-n.x,r=t.z-n.z;return e*e+i*i+r*r}},{key:"contains",value:function(t,n){var e=this.min,i=this.max;return t.x>=e.x-n&&t.y>=e.y-n&&t.z>=e.z-n&&t.x<=i.x+n&&t.y<=i.y+n&&t.z<=i.z+n}},{key:"redistribute",value:function(t){var n,e,i,r,o,l,a,u=this.children,s=this.points,c=this.data;if(null!==u&&null!==s){for(n=0,i=s.length;n<i;++n)for(l=s[n],a=c[n],e=0,r=u.length;e<r;++e)if((o=u[e]).contains(l,t)){null===o.points&&(o.points=[],o.data=[]),o.points.push(l),o.data.push(a);break}this.points=null,this.data=null}}},{key:"merge",value:function(){var t=this.children;if(null!==t){var n,e,i,r=[],o=[];for(n=0,e=t.length;n<e;++n)null!==(i=t[n]).points&&(r=r.concat(i.points),o=o.concat(i.data));this.children=null,this.points=r,this.data=o}}}]),n}(g);function _(t){var n,e,i=t.children,r=0;if(null!==i)for(n=0,e=i.length;n<e;++n)r+=_(i[n]);else null!==t.points&&(r=t.points.length);return r}function B(t,n,e,i,r){var o,l,a=i.children,u=!1,s=!1;if(i.contains(t,e.bias)){if(null===a){if(null===i.points)i.points=[],i.data=[];else for(o=0,l=i.points.length;!u&&o<l;++o)u=i.points[o].equals(t);u?(i.data[o-1]=n,s=!0):i.points.length<e.maxPoints||r===e.maxDepth?(i.points.push(t.clone()),i.data.push(n),++e.pointCount,s=!0):(i.split(),i.redistribute(e.bias),a=i.children)}if(null!==a)for(++r,o=0,l=a.length;!s&&o<l;++o)s=B(t,n,e,a[o],r)}return s}function I(t,n,e,i){var r,o,l,a,u,s=e.children,c=null;if(e.contains(t,n.bias))if(null!==s)for(r=0,o=s.length;null===c&&r<o;++r)c=I(t,n,s[r],e);else if(null!==e.points)for(l=e.points,a=e.data,r=0,o=l.length;r<o;++r)if(l[r].equals(t)){u=o-1,c=a[r],r<u&&(l[r]=l[u],a[r]=a[u]),l.pop(),a.pop(),--n.pointCount,null!==i&&_(i)<=n.maxPoints&&i.merge();break}return c}function N(t,n,e,i){var r,o,l=null,a=n;if(null!==i.children){var u,s,c=i.children.map((function(n){return{octant:n,distance:n.distanceToCenterSquared(t)}})).sort((function(t,n){return t.distance-n.distance}));for(r=0,o=c.length;r<o&&(!(u=c[r].octant).contains(t,a)||null===(s=N(t,a,e,u))||(l=s,0!==(a=s.distance)));++r);}else if(null!==i.points){var h,f=i.points,y=-1;for(r=0,o=f.length;r<o;++r)if(f[r].equals(t)){if(!e){a=0,y=r;break}}else(h=t.distanceTo(f[r]))<a&&(a=h,y=r);y>=0&&(l={point:f[y],data:i.data[y],distance:a})}return l}function L(t,n,e,i,r){var o,l,a,u=i.children;if(null!==u)for(o=0,l=u.length;o<l;++o)(a=u[o]).contains(t,n)&&L(t,n,e,a,r);else if(null!==i.points){var s,c=i.points,h=n*n;for(o=0,l=c.length;o<l;++o)(s=c[o]).equals(t)?e||r.push({point:s.clone(),data:i.data[o]}):s.distanceToSquared(t)<=h&&r.push({point:s.clone(),data:i.data[o]})}}var F=function(t){function n(t,e){var r,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;return i(this,n),(r=s(this,a(n).call(this,new E(t,e)))).bias=Math.max(0,o),r.maxPoints=Math.max(1,Math.round(l)),r.maxDepth=Math.max(0,Math.round(u)),r.pointCount=0,r}return l(n,t),o(n,[{key:"countPoints",value:function(t){return _(t)}},{key:"insert",value:function(t,n){return B(t,n,this,this.root,0)}},{key:"remove",value:function(t){return I(t,this,this.root,null)}},{key:"get",value:function(t){return function t(n,e,i){var r,o,l,a=i.children,u=null;if(i.contains(n,e.bias))if(null!==a)for(r=0,o=a.length;null===u&&r<o;++r)u=t(n,e,a[r]);else if(null!==i.points)for(r=0,o=(l=i.points).length;null===u&&r<o;++r)n.equals(l[r])&&(u=i.data[r]);return u}(t,this,this.root)}},{key:"move",value:function(t,n){return function t(n,e,i,r,o,l){var a,u,s,c=r.children,h=null;if(r.contains(n,i.bias))if(r.contains(e,i.bias)){if(null!==c)for(++l,a=0,u=c.length;null===h&&a<u;++a)h=t(n,e,i,c[a],r,l);else if(null!==r.points)for(a=0,u=(s=r.points).length;a<u;++a)if(n.equals(s[a])){s[a].copy(e),h=r.data[a];break}}else B(e,h=I(n,i,r,o),i,o,l-1);return h}(t,n,this,this.root,null,0)}},{key:"findNearestPoint",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,e=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=N(t,n,e,this.root);return null!==i&&(i.point=i.point.clone()),i}},{key:"findPoints",value:function(t,n){var e=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=[];return L(t,n,e,this.root,i),i}},{key:"raycast",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=c(a(n.prototype),"raycast",this).call(this,t);return i.length>0&&w(i,t,e),e}}]),n}(M);t.CubicOctant=p,t.Flags=x,t.Octant=g,t.Octree=M,t.OctreeIterator=V,t.OctreeRaycaster=j,t.PointOctant=E,t.PointOctree=F,t.RayPointIntersection=m,t.edges=f,t.findEntryOctant=b,t.findNextOctant=A,t.intersectOctree=S,t.layout=y,t.testPoints=w,Object.defineProperty(t,"__esModule",{value:!0})}));
